"use strict";var Promise=require("bluebird"),superagent=require("superagent"),helper=require("../utils/Helper"),fs=require("fs"),path=require("path"),TURBO_VECTOR_API_KEY_HEADER="Turbo-Vector-API-Key",NODE_MODULES_PATH="win32"==process.platform?"node_modules\\turbo360\\dist\\vertex":"node_modules/turbo360/dist/vertex",BUCKET="turbo360-vertex",fetchTextFile=function(e){return new Promise(function(r,t){superagent.get(e).query(null).end(function(e,n){if(e)return void t(e);r(n.text)})})},readFile=function(e){return new Promise(function(r,t){fs.readFile(e,"utf8",function(e,n){if(e)return void t(e);r(n)})})},Vertex=function(e){var r=e,t=null,n=function(e){return new Promise(function(n,i){if(0==helper.validateSiteId(r))return void i(new Error("Please Set Your TURBO_APP_ID"));helper.fetchSite(r,!1).then(function(r){if(t=r,"dev"==e){var n=path.join(__dirname,"/pages/global.json").replace(NODE_MODULES_PATH,"");return readFile(n)}return null}).then(function(e){if(null==e)n(t);else try{var r=Object.assign({},t);r.globalConfig=JSON.parse(e),n(r)}catch(e){n(t)}}).catch(function(e){i(e)})})};return{pageData:function(e){return new Promise(function(t,n){if(null==e)return void n(new Error("Please specify page name"));if(0==e.length)return void n(new Error("Please specify page name"));var i=e.toLowerCase().trim(),o="https://cdn.turbo360-vertex.com/pages/"+r.site_id+"-"+i+".json";superagent.get(o).query(null).set("Accept","application/json").end(function(e,r){if(e)return void n(e);t(r.body)})})},rawTemplate:function(e,t,n){return new Promise(function(i,o){if(null==e)return void o(new Error("Please specify template name"));if(0==e.length)return void o(new Error("Please specify template name"));if("dev"==n){var u=path.join(__dirname,"/views/"+e+".mustache").replace(NODE_MODULES_PATH,"");return void fs.readFile(u,"utf8",function(e,r){if(e)return void o(e);i(r)})}helper.fetchSite(r).then(function(r){if(r.api.key!=t)return void o(new Error("Unauthorized"));var n="https://cdn.turbo360-vertex.com/"+r.slug+"/views/"+e+".mustache";return helper.fetchTextFile(n)}).then(function(e){i(e)}).catch(function(e){o(e)})})},pageConfig:function(e,n,i){return new Promise(function(o,u){if(null==e)return void u(new Error("Please specify page name"));if(0==e.length)return void u(new Error("Please specify page name"));if("dev"==i){var a=path.join(__dirname,"/pages/"+e+".json").replace(NODE_MODULES_PATH,"");return void fs.readFile(a,"utf8",function(e,r){if(e)return void u(e);try{o(JSON.parse(r))}catch(e){u(e)}})}if(n.length<20)return void u(new Error("Please Set Your TURBO_API_KEY"));helper.fetchSite(r).then(function(r){if(r.api.key!=n)return void u(new Error("Unauthorized"));t=r;var i="https://s3.amazonaws.com/turbo360-vertex/pages/"+t.slug+"/"+e+".txt";return helper.fetchTextFile(i)}).then(function(e){var r=JSON.parse(e);o(r)}).catch(function(e){u(e)})})},updatePage:function(n,i,o){return new Promise(function(u,a){if(0==helper.validateSiteId(r))return void a(new Error("Please Set Your TURBO_APP_ID"));if(r.site_id.length<20)return void a(new Error("Please Set Your TURBO_APP_ID"));if(null==o)return void a(new Error("Please Set Your TURBO_API_KEY"));if(o.length<20)return void a(new Error("Please Set Your TURBO_API_KEY"));if(null==n)return void a(new Error("Please specify page name"));if(0==n.length)return void a(new Error("Please specify page name"));var s=n+".txt";helper.fetchSite(r).then(function(r){if(r.api.key!=o)return void a(new Error("Unauthorized"));t=r;var l={bucket:BUCKET,filename:s,filetype:"text/plain",folder:"pages/"+t.slug},f=e.turbo_url+"/account/uploadurl";superagent.post(f).send(l).set("Accept","application/json").end(function(e,r){if(e)return void a(e);if("success"!=r.body.confirmation)return void a(new Error(r.body.message));var t={name:s,type:"text/plain"};superagent.put(r.body.data.upload).send(i).set("Content-Type",t.type).end(function(e,r){if(e)return void a(e);u({page:n,status:n+" successfully updated"})})})}).catch(function(e){a(e)})})},currentApp:n}};module.exports=Vertex;